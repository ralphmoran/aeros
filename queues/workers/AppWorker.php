<?php

namespace Aeros\Queues\Workers;

use Aeros\Lib\Classes\Worker;

class AppWorker extends Worker
{
    /**
     * WARNING: DO NOT EDIT THIS FILE, UNLESS YOU KNOW WHAT YOU ARE DOING
     * 
     * This is the main worker for the application. It handles all the registered
     * pipelines (Jobs) in the queue systeme (Redis).
     *
     * @return void
     */
    public function handle()
    {
        app()->queue->processPipeline();
    }

    /**
     * Calls the requested worker and puts it to do its job.
     *
     * @param string $workerName
     * @return void
     */
    public function call(string $worker)
    {
        if (! $this->isWorkerValid($worker)) {
            throw new \Exception(
                sprintf('ERROR[Worker] There was a problem validating worker \'%s\.', $worker)
            );
        }

        (new $worker)->handle();
    }

    /**
     * Calls all the registered workers in ./config/workers.php.
     *
     * @return void
     */
    public function callAll(array $workers = [])
    {
        $workers = ! empty($workers) ? $workers : config('workers');

        if (is_array($workers) && ! empty($workers)) {
            foreach ($workers as $worker) {
                $this->call($worker);
            }
        }
    }

    /**
     * Checks if a worker is valid.
     *
     * @param string $worker
     * @return boolean
     */
    private function isWorkerValid(string $worker): bool
    {
        return (! class_exists($worker) || get_parent_class($worker) != Worker::class);
    }
}
